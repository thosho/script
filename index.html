<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fountain to Screenplay Converter</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #f8f8f8;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #toolbar {
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        #editor {
            width: 100%;
            max-width: 800px;
            height: 300px;
            font-size: 16px;
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        #output {
            width: 100%;
            max-width: 800px;
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            white-space: pre-wrap;
            line-height: 1.5;
            box-sizing: border-box;
        }
        .title-page {
            text-align: center;
            margin-bottom: 50px;
        }
        .scene-heading {
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 20px;
        }
        .action {
            margin: 10px 0;
        }
        .character {
            text-transform: uppercase;
            margin-left: 200px;
            margin-top: 20px;
        }
        .dialogue {
            margin-left: 150px;
            margin-right: 150px;
        }
        .parenthetical {
            margin-left: 180px;
        }
        .transition {
            text-align: right;
            text-transform: uppercase;
            font-weight: bold;
            margin: 20px 0;
        }
        #info-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 1px solid #ccc;
            z-index: 1000;
            max-width: 80%;
        }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            #editor {
                height: 200px;
            }
            .character {
                margin-left: 100px;
            }
            .dialogue {
                margin-left: 50px;
                margin-right: 50px;
            }
            .parenthetical {
                margin-left: 80px;
            }
            #toolbar {
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button id="new-btn">New Project</button>
        <button id="save-fountain">Save as .fountain</button>
        <button id="save-fdx">Save as .fdx</button>
        <button id="save-pdf">Save as PDF</button>
        <button id="share-btn">Share</button>
        <button id="undo-btn">Undo</button>
        <button id="redo-btn">Redo</button>
        <button id="convert-btn">Convert</button>
        <button id="info-btn">Info</button>
    </div>
    <textarea id="editor" placeholder="Enter your Fountain markup here..."></textarea>
    <div id="output"></div>
    <div id="info-modal">
        <p>This is a simple Fountain to Screenplay converter inspired by DubScript. Features include saving in multiple formats, undo/redo, scene numbering, and more. For full pro features, consider the DubScript app.</p>
        <button id="close-info">Close</button>
    </div>

    <!-- Include jsPDF for PDF export (CDN for simplicity; download for offline use) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Undo/Redo stack
        let undoStack = [];
        let redoStack = [];
        const editor = document.getElementById('editor');
        editor.addEventListener('input', () => {
            undoStack.push(editor.value);
            redoStack = []; // Clear redo on new input
        });

        document.getElementById('undo-btn').addEventListener('click', () => {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                editor.value = undoStack[undoStack.length - 1];
            }
        });

        document.getElementById('redo-btn').addEventListener('click', () => {
            if (redoStack.length > 0) {
                undoStack.push(redoStack.pop());
                editor.value = undoStack[undoStack.length - 1];
            }
        });

        // Enhanced Fountain parser with scene numbering
        function parseFountain(input, addSceneNumbers = true) {
            const lines = input.split('\n');
            let html = '';
            let inDialogue = false;
            let sceneNumber = 1;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // Title page
                if (line.includes(':')) {
                    const [key, value] = line.split(':');
                    if (['Title', 'Author', 'Draft date'].includes(key.trim())) {
                        html += `<div class="title-page"><h1>${value.trim()}</h1></div>`;
                        return;
                    }
                }

                // Scene headings with optional numbering
                if (line.toUpperCase().startsWith('INT.') || line.toUpperCase().startsWith('EXT.')) {
                    const numberedLine = addSceneNumbers ? `${sceneNumber}. ${line.toUpperCase()}` : line.toUpperCase();
                    html += `<div class="scene-heading">${numberedLine}</div>`;
                    sceneNumber++;
                    inDialogue = false;
                    return;
                }

                // Transitions
                if (line.toUpperCase().endsWith('TO:') || line.toUpperCase() === 'FADE OUT.') {
                    html += `<div class="transition">${line.toUpperCase()}</div>`;
                    inDialogue = false;
                    return;
                }

                // Character
                if (line === line.toUpperCase() && !line.startsWith('!') && line.length > 0) {
                    html += `<div class="character">${line}</div>`;
                    inDialogue = true;
                    return;
                }

                // Parenthetical
                if (inDialogue && line.startsWith('(')) {
                    html += `<div class="parenthetical">${line}</div>`;
                    return;
                }

                // Dialogue
                if (inDialogue) {
                    html += `<div class="dialogue">${line}</div>`;
                    return;
                }

                // Action
                html += `<div class="action">${line}</div>`;
            });

            return html;
        }

        // Convert button
        document.getElementById('convert-btn').addEventListener('click', () => {
            const input = editor.value;
            undoStack.push(input); // Save state
            const output = parseFountain(input);
            document.getElementById('output').innerHTML = output;
        });

        // New project button
        document.getElementById('new-btn').addEventListener('click', () => {
            if (confirm('Start a new project? Unsaved changes will be lost.')) {
                editor.value = '';
                document.getElementById('output').innerHTML = '';
                undoStack = [];
                redoStack = [];
            }
        });

        // Save as .fountain
        document.getElementById('save-fountain').addEventListener('click', () => {
            const blob = new Blob([editor.value], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'script.fountain';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Save as .fdx (simple XML structure inspired by Final Draft format)
        document.getElementById('save-fdx').addEventListener('click', () => {
            const input = editor.value;
            const parsed = parseFountain(input, false); // Get HTML for basic content
            const fdxContent = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<FinalDraft DocumentType="Script" Template="No" Version="1">
<Content>${parsed.replace(/<[^>]+>/g, '')}</Content> <!-- Simplified; use full library for accurate .fdx -->
</FinalDraft>`;
            const blob = new Blob([fdxContent], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'script.fdx';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Save as PDF using jsPDF
        document.getElementById('save-pdf').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont('courier');
            doc.setFontSize(12);
            const lines = editor.value.split('\n');
            let y = 20;
            lines.forEach(line => {
                doc.text(line, 10, y);
                y += 10;
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
            });
            doc.save('script.pdf');
        });

        // Share button (uses Web Share API for mobile)
        document.getElementById('share-btn').addEventListener('click', () => {
            if (navigator.share) {
                navigator.share({
                    title: 'My Screenplay',
                    text: editor.value,
                }).catch(console.error);
            } else {
                alert('Share API not supported; copy text manually.');
            }
        });

        // Info button
        const infoModal = document.getElementById('info-modal');
        document.getElementById('info-btn').addEventListener('click', () => {
            infoModal.style.display = 'block';
        });
        document.getElementById('close-info').addEventListener('click', () => {
            infoModal.style.display = 'none';
        });
    </script>
</body>
</html>
