<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fountain Script Pro</title>
    <!-- Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a classic screenplay look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- jsPDF and html2canvas for PDF export functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Using your provided CSS classes for formatting, adapted for the UI */
        body {
            font-family: 'Inter', sans-serif;
        }
        #screenplay-output {
            font-family: 'Courier New', monospace;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .title-page { text-align: center; margin-bottom: 0; }
        .title-page h1 { font-weight: bold; margin-bottom: 0.25rem; }
        .scene-heading { font-weight: bold; text-transform: uppercase; margin-top: 20px; }
        .action { margin: 10px 0; }
        .character { text-transform: uppercase; margin-left: 37%; margin-top: 20px; }
        .dialogue { margin-left: 25%; margin-right: 15%; }
        .parenthetical { margin-left: 30%; }
        .transition { text-align: right; text-transform: uppercase; font-weight: bold; margin: 20px 0; }

        /* Custom scrollbar for a cleaner look */
        textarea::-webkit-scrollbar, #screenplay-output::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #1f2937; }
        textarea::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; }
        #screenplay-output::-webkit-scrollbar-track { background: #e5e7eb; }
        #screenplay-output::-webkit-scrollbar-thumb { background-color: #9ca3af; }
        
        #info-modal { transition: opacity 0.3s ease; }
        .main-content { height: calc(100vh - 50px); }

        /* Rule to hide elements in fullscreen */
        :fullscreen #main-toolbar, :fullscreen #main-header {
            display: none;
        }
        :fullscreen .main-content {
            height: 100vh;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col h-screen overflow-hidden">

    <!-- Header Section -->
    <header id="main-header" class="text-center py-2 border-b border-gray-700 relative flex items-center justify-between px-4">
        <!-- Hamburger Menu Button -->
        <button id="hamburger-btn" class="text-white p-2 rounded-full hover:bg-gray-700 z-30" title="Menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
            </svg>
        </button>
        
        <h1 class="text-2xl font-bold text-white absolute left-1/2 -translate-x-1/2">Fountain Script Pro</h1>

        <!-- Fullscreen Toggle Button -->
        <button id="fullscreen-btn" class="text-white p-2 rounded-full hover:bg-gray-700 z-30" title="Toggle Fullscreen">
            <svg id="fullscreen-open-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/>
            </svg>
            <svg id="fullscreen-close-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-fullscreen-exit hidden" viewBox="0 0 16 16">
                <path d="M5.5 0a.5.5 0 0 1 .5.5v4A.5.5 0 0 1 5 5h-4a.5.5 0 0 1 0-1h3.5V.5a.5.5 0 0 1 .5-.5zm-5 5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V6.5H.5a.5.5 0 0 1-.5-.5zm10.5 5.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-3.5V15.5a.5.5 0 0 1-1 0v-4zM11 5.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v3.5a.5.5 0 0 1-1 0V6.5h-3a.5.5 0 0 1-.5-.5z"/>
            </svg>
        </button>
    </header>
    
    <!-- Hamburger Menu Panel -->
    <div id="menu-panel" class="absolute top-14 left-0 w-64 bg-gray-800 shadow-lg z-40 transform -translate-x-full transition-transform duration-300 ease-in-out rounded-br-lg">
        <div class="p-4">
            <h2 class="text-xl font-bold text-white mb-4">Menu</h2>
            <nav class="flex flex-col space-y-2">
                <a href="#" id="new-btn" class="text-gray-300 hover:bg-gray-700 p-2 rounded-md">New Project</a>
                <div class="relative">
                    <a href="#" id="save-menu-btn" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">Save As...</a>
                    <div id="save-menu" class="mt-1 ml-4 hidden">
                        <a href="#" id="save-fountain-btn" class="block text-gray-300 hover:bg-gray-600 p-2 rounded-md">.fountain</a>
                        <a href="#" id="save-fdx-btn" class="block text-gray-300 hover:bg-gray-600 p-2 rounded-md">.fdx</a>
                        <a href="#" id="save-pdf-btn" class="block text-gray-300 hover:bg-gray-600 p-2 rounded-md">.pdf</a>
                    </div>
                </div>
                <a href="#" id="share-btn" class="text-gray-300 hover:bg-gray-700 p-2 rounded-md">Share</a>
                <a href="#" id="info-btn" class="text-gray-300 hover:bg-gray-700 p-2 rounded-md">Info</a>
            </nav>
        </div>
    </div>


    <!-- Main Content Area -->
    <main class="main-content flex-grow overflow-hidden">
        <!-- Write View (Editor) -->
        <div id="write-view" class="h-full flex flex-col">
            <!-- Toolbar -->
            <div id="main-toolbar" class="bg-gray-800 p-2 flex items-center justify-center flex-wrap gap-2 shadow-md flex-shrink-0">
                <button id="undo-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md text-sm disabled:opacity-50" disabled title="Undo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/></svg>
                </button>
                <button id="redo-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md text-sm disabled:opacity-50" disabled title="Redo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966a.25.25 0 0 1 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                </button>
                <button id="zoom-out-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" title="Zoom Out">-</button>
                <button id="zoom-in-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" title="Zoom In">+</button>
            </div>
            <!-- Textarea and Side Toolbar Wrapper -->
            <div class="flex-grow p-4 flex gap-2 overflow-hidden">
                 <textarea id="fountain-input" class="w-full h-full bg-gray-800 border border-gray-700 rounded-lg p-4 text-gray-200 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                 <!-- Side Toolbar -->
                 <div class="flex flex-col gap-2">
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="caps" title="Toggle Case">C</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="parens" title="Add Parentheses">()</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="int" title="Insert INT.">I</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="ext" title="Insert EXT.">E</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="day" title="Insert DAY">D</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="night" title="Insert NIGHT">N</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" data-action="transition" title="Cycle Transition">T</button>
                 </div>
            </div>
             <!-- Action Button Area -->
            <div class="p-4 flex-shrink-0">
                <!-- Ad Banner Placeholder -->
                <div class="ad-banner-placeholder w-full h-16 bg-gray-700 flex items-center justify-center text-gray-400 mb-4 rounded-lg">
                    Ad Banner Space
                </div>
                <button id="show-script-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg">SCRIPT</button>
            </div>
        </div>

        <!-- Script View (Preview) -->
        <div id="script-view" class="h-full flex-col hidden">
            <div class="flex-grow p-4 overflow-hidden">
                <div id="screenplay-output" class="w-full h-full bg-white text-black rounded-lg p-6 md:p-8 overflow-y-auto">
                    <!-- Formatted screenplay will be injected here -->
                </div>
            </div>
             <!-- Action Button Area -->
            <div class="p-4 flex-shrink-0">
                <!-- Ad Banner Placeholder -->
                <div class="ad-banner-placeholder w-full h-16 bg-gray-700 flex items-center justify-center text-gray-400 mb-4 rounded-lg">
                    Ad Banner Space
                </div>
                <button id="show-write-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg text-lg">WRITE</button>
            </div>
        </div>
    </main>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full p-6 relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-white">About Fountain Script Pro</h2>
            <p class="text-gray-300 mb-4">This tool auto-formats your text into a screenplay. It's designed to be fast, offline-first, and mobile-friendly.</p>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const fountainInput = document.getElementById('fountain-input');
        const screenplayOutput = document.getElementById('screenplay-output');
        const newBtn = document.getElementById('new-btn');
        const saveMenuBtn = document.getElementById('save-menu-btn');
        const saveMenu = document.getElementById('save-menu');
        const saveFountainBtn = document.getElementById('save-fountain-btn');
        const saveFdxBtn = document.getElementById('save-fdx-btn');
        const savePdfBtn = document.getElementById('save-pdf-btn');
        const shareBtn = document.getElementById('share-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const infoBtn = document.getElementById('info-btn');
        const infoModal = document.getElementById('info-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const writeView = document.getElementById('write-view');
        const scriptView = document.getElementById('script-view');
        const showScriptBtn = document.getElementById('show-script-btn');
        const showWriteBtn = document.getElementById('show-write-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const fullscreenOpenIcon = document.getElementById('fullscreen-open-icon');
        const fullscreenCloseIcon = document.getElementById('fullscreen-close-icon');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const menuPanel = document.getElementById('menu-panel');
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');

        // --- Initial Sample Script ---
        const sampleScript = `Title: My Awesome Script
Author: A. Writer

INT. APARTMENT - DAY

A sparse, modern apartment. A MAN IN A HAT stands by the window.

JANE (28)
(smiling)
You're going to wear a hole in that keyboard.

MARK
This proposal is due in an hour.

FADE OUT.`;

        // --- Undo/Redo Manager ---
        const history = {
            stack: [""],
            currentIndex: 0,
            add(value) {
                if (value === this.stack[this.currentIndex]) return;
                this.stack = this.stack.slice(0, this.currentIndex + 1);
                this.stack.push(value);
                this.currentIndex++;
                this.updateButtons();
            },
            undo() { if (this.canUndo()) { this.currentIndex--; this.updateInput(); } },
            redo() { if (this.canRedo()) { this.currentIndex++; this.updateInput(); } },
            canUndo: () => history.currentIndex > 0,
            canRedo: () => history.currentIndex < history.stack.length - 1,
            updateInput() {
                fountainInput.value = this.stack[this.currentIndex];
                this.updateButtons();
            },
            updateButtons() {
                undoBtn.disabled = !this.canUndo();
                redoBtn.disabled = !this.canRedo();
            }
        };

        // --- PARSING ENGINE FROM YOUR PROVIDED CODE ---
        function parseFountain(input, addSceneNumbers = true) {
            const lines = input.split('\n');
            let html = '';
            let inDialogue = false;
            let sceneNumber = 1;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // Title page
                if (line.includes(':')) {
                    const [key, value] = line.split(':');
                    if (['Title', 'Author', 'Draft date'].includes(key.trim())) {
                        html += `<div class="title-page"><h1>${value.trim()}</h1></div>`;
                        return;
                    }
                }

                // Scene headings with optional numbering
                if (line.toUpperCase().startsWith('INT.') || line.toUpperCase().startsWith('EXT.')) {
                    const numberedLine = addSceneNumbers ? `<div class="flex justify-between"><span>${line.toUpperCase()}</span><span>${sceneNumber}</span></div>` : line.toUpperCase();
                    html += `<div class="scene-heading">${numberedLine}</div>`;
                    sceneNumber++;
                    inDialogue = false;
                    return;
                }

                // Transitions
                if (line.toUpperCase().endsWith('TO:') || line.toUpperCase() === 'FADE OUT.' || line.toUpperCase() === 'FADE IN:' || line.toUpperCase() === 'FADE TO BLACK:') {
                    html += `<div class="transition">${line.toUpperCase()}</div>`;
                    inDialogue = false;
                    return;
                }

                // Character
                if (line === line.toUpperCase() && !line.startsWith('!') && line.length > 0) {
                    html += `<div class="character">${line}</div>`;
                    inDialogue = true;
                    return;
                }

                // Parenthetical
                if (inDialogue && line.startsWith('(')) {
                    html += `<div class="parenthetical">${line}</div>`;
                    return;
                }

                // Dialogue
                if (inDialogue) {
                    html += `<div class="dialogue">${line}</div>`;
                    return;
                }

                // Action
                html += `<div class="action">${line}</div>`;
            });

            return html;
        }

        function renderPreview() {
            const rawText = fountainInput.value;
            const formattedHtml = parseFountain(rawText);
            screenplayOutput.innerHTML = formattedHtml;
        }

        // --- File & Action Handlers ---
        function downloadFile(filename, content, mimeType) {
            const element = document.createElement('a');
            element.setAttribute('href', `data:${mimeType};charset=utf-8,` + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
        
        function createFdxContent(fountainText) {
            const parsed = parseFountain(fountainText, false); // Get HTML for basic content
            const fdxContent = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<FinalDraft DocumentType="Script" Template="No" Version="1">
<Content>${parsed.replace(/<[^>]+>/g, '')}</Content>
</FinalDraft>`;
            return fdxContent;
        }

        // --- Textarea Manipulation Helpers ---
        let lastTransition = { text: null, start: -1, end: -1 };
        const transitions = ['CUT TO:', 'FADE IN:', 'FADE OUT:', 'FADE TO BLACK:'];

        function cycleTransition(textarea) {
            const currentPos = textarea.selectionStart;

            if (lastTransition.text && currentPos === lastTransition.end && textarea.value.substring(lastTransition.start, lastTransition.end) === lastTransition.text) {
                const currentIndex = transitions.indexOf(lastTransition.text);
                const nextIndex = (currentIndex + 1) % transitions.length;
                const newText = transitions[nextIndex];

                textarea.value = textarea.value.substring(0, lastTransition.start) + newText + textarea.value.substring(lastTransition.end);
                textarea.selectionStart = textarea.selectionEnd = lastTransition.start + newText.length;

                lastTransition.text = newText;
                lastTransition.end = lastTransition.start + newText.length;
            } else {
                const newText = transitions[0];
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + newText.length;
                
                lastTransition.start = start;
                lastTransition.end = start + newText.length;
                lastTransition.text = newText;
            }
            textarea.focus();
            history.add(textarea.value);
        }

        function insertAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            textarea.focus();
            history.add(textarea.value); // Update history
        }

        function wrapWithParens(textarea) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const newText = `(${selectedText})`;
            textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
            textarea.selectionStart = start + 1;
            textarea.selectionEnd = end + 1;
            textarea.focus();
            history.add(textarea.value); // Update history
        }

        function toggleCase(textarea) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            let newText = '';
            let targetText = '';

            if (start === end) { // No selection, toggle the whole line
                let lineStart = textarea.value.lastIndexOf('\n', start - 1) + 1;
                let lineEnd = textarea.value.indexOf('\n', start);
                if (lineEnd === -1) lineEnd = textarea.value.length;
                
                targetText = textarea.value.substring(lineStart, lineEnd);
                newText = (targetText === targetText.toUpperCase()) ? targetText.toLowerCase() : targetText.toUpperCase();
                textarea.value = textarea.value.substring(0, lineStart) + newText + textarea.value.substring(lineEnd);
                textarea.selectionStart = start;
                textarea.selectionEnd = end;

            } else { // Toggle selection
                targetText = textarea.value.substring(start, end);
                newText = (targetText === targetText.toUpperCase()) ? targetText.toLowerCase() : targetText.toUpperCase();
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                textarea.selectionStart = start;
                textarea.selectionEnd = start + newText.length;
            }
            textarea.focus();
            history.add(textarea.value); // Update history
        }

        // --- Event Listeners ---
        // Menu Buttons
        newBtn.addEventListener('click', () => {
            if (confirm('Start a new project? Unsaved changes will be lost.')) {
                fountainInput.value = '';
                screenplayOutput.innerHTML = '';
                history.stack = [''];
                history.currentIndex = 0;
                history.updateButtons();
                menuPanel.classList.add('-translate-x-full');
            }
        });
        saveMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            saveMenu.classList.toggle('hidden');
        });
        saveFountainBtn.addEventListener('click', (e) => { e.preventDefault(); downloadFile('script.fountain', fountainInput.value, 'text/plain'); });
        saveFdxBtn.addEventListener('click', (e) => { e.preventDefault(); downloadFile('script.fdx', createFdxContent(fountainInput.value), 'application/xml'); });
        shareBtn.addEventListener('click', () => {
            if (navigator.share) {
                navigator.share({ title: 'My Screenplay', text: fountainInput.value }).catch(console.error);
            } else {
                alert('Share API not supported; copy text manually.');
            }
        });
        infoBtn.addEventListener('click', () => {
            infoModal.classList.remove('hidden');
            menuPanel.classList.add('-translate-x-full');
        });

        // Toolbar Action Buttons
        document.querySelectorAll('.action-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const action = e.currentTarget.dataset.action;
                switch(action) {
                    case 'caps': toggleCase(fountainInput); break;
                    case 'parens': wrapWithParens(fountainInput); break;
                    case 'int': insertAtCursor(fountainInput, 'INT. '); break;
                    case 'ext': insertAtCursor(fountainInput, 'EXT. '); break;
                    case 'day': insertAtCursor(fountainInput, ' - DAY'); break;
                    case 'night': insertAtCursor(fountainInput, ' - NIGHT'); break;
                    case 'transition': cycleTransition(fountainInput); break;
                }
            });
        });

        // PDF Save (requires html2canvas)
        savePdfBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            renderPreview();
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
            screenplayOutput.style.width = '595pt';
            const canvas = await html2canvas(screenplayOutput, { scale: 2 });
            screenplayOutput.style.width = '';
            const imgData = canvas.toDataURL('image/png');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            let heightLeft = pdfHeight;
            let position = 0;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            heightLeft -= pdf.internal.pageSize.getHeight();
            while (heightLeft > 0) {
                position = heightLeft - pdfHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();
            }
            pdf.save('script.pdf');
        });

        let inputTimeout;
        fountainInput.addEventListener('input', () => {
            clearTimeout(inputTimeout);
            inputTimeout = setTimeout(() => history.add(fountainInput.value), 300); // Debounce for performance
        });

        undoBtn.addEventListener('click', () => history.undo());
        redoBtn.addEventListener('click', () => history.redo());
        
        closeModalBtn.addEventListener('click', () => infoModal.classList.add('hidden'));
        
        // View Switching Logic
        showScriptBtn.addEventListener('click', () => {
            renderPreview();
            writeView.classList.add('hidden');
            scriptView.classList.add('flex');
            scriptView.classList.remove('hidden');
        });

        showWriteBtn.addEventListener('click', () => {
            scriptView.classList.add('hidden');
            scriptView.classList.remove('flex');
            writeView.classList.remove('hidden');
        });

        // Hamburger Menu Logic
        hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            menuPanel.classList.toggle('-translate-x-full');
        });
        document.addEventListener('click', (e) => {
            if (!menuPanel.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                 menuPanel.classList.add('-translate-x-full');
            }
        });

        // Fullscreen Logic
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        });

        document.addEventListener('fullscreenchange', () => {
            const isFullscreen = !!document.fullscreenElement;
            fullscreenOpenIcon.classList.toggle('hidden', isFullscreen);
            fullscreenCloseIcon.classList.toggle('hidden', !isFullscreen);
        });
        
        // Zoom Logic
        let currentFontSize = 16; // Initial font size in pixels
        const updateFontSize = () => {
            fountainInput.style.fontSize = `${currentFontSize}px`;
        };
        zoomInBtn.addEventListener('click', () => {
            currentFontSize += 2;
            updateFontSize();
        });
        zoomOutBtn.addEventListener('click', () => {
            currentFontSize = Math.max(8, currentFontSize - 2); // Minimum font size of 8px
            updateFontSize();
        });

        // --- Initialization ---
        fountainInput.value = sampleScript.trim();
        history.stack = [fountainInput.value, sampleScript.trim()];
        history.currentIndex = 1;
        history.updateButtons();
        updateFontSize();
    </script>
</body>
</html>
