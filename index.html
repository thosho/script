<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fountain Script Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Using your provided CSS classes for formatting, adapted for the UI */
        body {
            font-family: 'Inter', sans-serif;
        }
        #screenplay-output {
            font-family: 'Courier New', monospace;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .title-page { text-align: center; margin-bottom: 0; padding-top: 2rem; }
        .title-page h1 { font-weight: bold; margin-bottom: 0.25rem; text-transform: uppercase; }
        .scene-heading { font-weight: bold; text-transform: uppercase; }
        .action { /* No margin needed, spacing controlled by <br> */ }
        .character { text-transform: uppercase; margin-left: 37%; }
        .dialogue { margin-left: 25%; margin-right: 15%; }
        .parenthetical { margin-left: 30%; }
        .transition { text-align: right; text-transform: uppercase; font-weight: bold; }

        /* Custom scrollbar for a cleaner look */
        textarea::-webkit-scrollbar, #screenplay-output::-webkit-scrollbar, #scene-list::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track, #screenplay-output::-webkit-scrollbar-track, #scene-list::-webkit-scrollbar-track { background: #1f2937; }
        textarea::-webkit-scrollbar-thumb, #screenplay-output::-webkit-scrollbar-thumb, #scene-list::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; }
        #screenplay-output::-webkit-scrollbar-track { background: #e5e7eb; }
        #screenplay-output::-webkit-scrollbar-thumb { background-color: #9ca3af; }
        
        #info-modal { transition: opacity 0.3s ease; }
        .main-content { height: calc(100vh - 50px); }

        /* Rule to hide elements in fullscreen */
        :fullscreen #main-toolbar, :fullscreen #main-header {
            display: none;
        }
        :fullscreen .main-content {
            height: 100vh;
        }

        .dragging {
            opacity: 0.5;
            background: #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col h-screen overflow-hidden">

    <header id="main-header" class="text-center py-2 border-b border-gray-700 relative flex items-center justify-between px-4">
        <button id="hamburger-btn" class="text-white p-2 rounded-full hover:bg-gray-700 z-30" title="Menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
            </svg>
        </button>
        
        <h1 class="text-2xl font-bold text-white absolute left-1/2 -translate-x-1/2" style="font-family: 'Courier Prime', monospace;">
            ToscripT
        </h1>

        <div class="flex items-center gap-2">
            <button id="scene-navigator-btn" class="text-white p-2 rounded-full hover:bg-gray-700 z-30" title="Scene Navigator">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-list-nested" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.5 11.5A.5.5 0 0 1 5 11h10a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zm-2-4A.5.5 0 0 1 3 7h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm-2-4A.5.5 0 0 1 1 3h10a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </button>
        </div>
    </header>
    
    <div id="menu-panel" class="absolute top-14 left-0 w-52 bg-gray-800 shadow-lg z-40 transform -translate-x-full transition-transform duration-300 ease-in-out rounded-br-lg">
        <div class="p-4">
            <nav class="flex flex-col space-y-2">
                <a href="#" id="new-btn" class="text-gray-300 hover:bg-gray-700 p-2 rounded-md">New Project</a>
                <a href="#" id="open-btn" class="text-gray-300 hover:bg-gray-700 p-2 rounded-md">Open...</a>
                <a href="#" id="title-page-btn" class="text-gray-300 hover:bg-gray-700 p-2 rounded-md">Title Page</a>
                <div class="relative">
                    <a href="#" id="save-menu-btn" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">Save As...</a>
                    <div id="save-menu" class="mt-1 ml-4 hidden">
                        <a href="#" id="save-fountain-btn" class="block text-gray-300 hover:bg-gray-600 p-2 rounded-md">.fountain</a>
                        <a href="#" id="save-fdx-btn" class="block text-gray-300 hover:bg-gray-600 p-2 rounded-md">.fdx</a>
                        <a href="#" id="save-pdf-btn" class="block text-gray-300 hover:bg-gray-600 p-2 rounded-md">.pdf</a>
                    </div>
                </div>
                 <a href="#" id="auto-save-btn" class="text-gray-300 hover:bg-gray-700 p-2 rounded-md flex justify-between items-center">
                    <span>Auto-Save</span>
                    <span id="auto-save-indicator" class="w-4 h-4 rounded-full bg-gray-500"></span>
                </a>
                <a href="#" id="share-btn" class="text-gray-300 hover:bg-gray-700 p-2 rounded-md">Share</a>
                <a href="#" id="scene-no-btn" class="text-gray-300 hover:bg-gray-700 p-2 rounded-md flex justify-between items-center">
                    <span>Scene Nos.</span>
                    <span id="scene-no-indicator" class="w-4 h-4 rounded-full bg-green-500"></span>
                </a>
                <a href="#" id="info-btn" class="text-gray-300 hover:bg-gray-700 p-2 rounded-md">Info</a>
            </nav>
        </div>
    </div>


    <main class="main-content flex-grow overflow-hidden">
        <div id="write-view" class="h-full flex flex-col">
            <div id="main-toolbar" class="bg-gray-800 p-2 flex items-center justify-center flex-wrap gap-2 shadow-md flex-shrink-0">
                <button id="zoom-in-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" title="Zoom In">+</button>
                <button id="zoom-out-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm" title="Zoom Out">-</button>
            </div>
            <div class="flex-grow p-4 flex gap-2 overflow-hidden relative">
                 <textarea id="fountain-input" class="flex-grow h-full bg-gray-800 border border-gray-700 rounded-lg p-4 text-gray-200 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <div id="desktop-side-toolbar" class="flex flex-col gap-2 flex-shrink-0">
                    <button id="fullscreen-btn-inline-editor" class="bg-gray-700 hover:bg-gray-800 text-white font-bold p-2 rounded-md text-2xl" title="Toggle Fullscreen">â›¶</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-md text-sm" data-action="scene" title="Cycle Scene">I/E</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-md text-sm" data-action="time" title="Cycle Time">D/N</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-md text-sm" data-action="caps" title="Toggle Case">C</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-md text-sm" data-action="parens" title="Add Parentheses">()</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-md text-sm" data-action="transition" title="Cycle Transition">T</button>
                    <button id="undo-btn-side" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md text-sm disabled:opacity-50" disabled title="Undo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/></svg>
                    </button>
                    <button id="redo-btn-side" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md text-sm disabled:opacity-50" disabled title="Redo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966a.25.25 0 0 1 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                    </button>
                </div>
            </div>
            <div class="p-4 flex-shrink-0">
                <div class="ad-banner-placeholder w-full h-16 bg-gray-700 flex items-center justify-center text-gray-400 mb-4 rounded-lg">
                    Ad Banner Space
                </div>
                <div id="mobile-bottom-toolbar" class="hidden bg-gray-800 p-2 items-center justify-around flex-wrap gap-2 shadow-md rounded-lg">
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md text-sm" data-action="caps" title="Toggle Case">C</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md text-sm" data-action="parens" title="Add Parentheses">()</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md text-sm" data-action="scene" title="Cycle Scene">I/E</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md text-sm" data-action="time" title="Cycle Time">D/N</button>
                    <button class="action-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md text-sm" data-action="transition" title="Cycle Transition">T</button>
                </div>
                <button id="show-script-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg">TO SCRIPT</button>
            </div>
        </div>

        <div id="script-view" class="h-full flex-col hidden relative">
            <div class="flex-grow p-4 overflow-hidden">
                <div id="screenplay-output" class="w-full h-full bg-white text-black rounded-lg p-6 md:p-8 overflow-y-auto">
                    </div>
            </div>
            <div class="p-4 flex-shrink-0">
                <div class="ad-banner-placeholder w-full h-16 bg-gray-700 flex items-center justify-center text-gray-400 mb-4 rounded-lg">
                    Ad Banner Space
                </div>
                <button id="show-write-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg text-lg">TO WRITE</button>
            </div>
        </div>
    </main>

    <div id="scene-navigator-panel" class="absolute top-0 right-0 h-full w-80 bg-gray-800 shadow-lg z-40 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-white">Scene Navigator</h2>
                <p class="text-sm text-gray-400">Drag to reorder scenes</p>
            </div>
            <button id="close-navigator-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <ul id="scene-list" class="flex-grow overflow-y-auto p-2">
            </ul>
    </div>

    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full p-6 relative overflow-y-auto max-h-[85vh]">
            <button id="close-info-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-white">Info & Help</h2>
            <h3 class="text-xl font-semibold mt-4 mb-2 text-white">Fountain Syntax</h3>
            <ul class="list-disc list-inside text-gray-300 space-y-1">
                <li><strong class="text-white">Scene Heading:</strong> Line starts with `INT.` or `EXT.`.</li>
                <li><strong class="text-white">Character:</strong> Any line in all uppercase.</li>
                <li><strong class="text-white">Dialogue:</strong> Any text following a Character.</li>
                <li><strong class="text-white">Parenthetical:</strong> Text inside `(parentheses)` below a Character.</li>
                <li><strong class="text-white">Transition:</strong> Line ends with `TO:` or is `FADE OUT.` etc.</li>
            </ul>
            <h3 class="text-xl font-semibold mt-6 mb-2 text-white">Button Guide</h3>
            <ul class="list-disc list-inside text-gray-300 space-y-1">
                <li><strong class="text-white">C:</strong> Toggles selected text or current line between UPPERCASE and lowercase.</li>
                <li><strong class="text-white">():</strong> Wraps selected text in parentheses.</li>
                <li><strong class="text-white">I / E:</strong> Inserts `INT.` or `EXT.` for scene headings.</li>
                <li><strong class="text-white">D / N:</strong> Appends ` - DAY` or ` - NIGHT` to the current line.</li>
                <li><strong class="text-white">T:</strong> Inserts and cycles through transitions (`CUT TO:`, `FADE IN:`, etc.).</li>
            </ul>
        </div>
    </div>
    
    <div id="title-page-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6 relative">
             <button id="close-title-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-white">Title Page</h2>
            <div class="space-y-4">
                <div>
                    <label for="title-input" class="block text-sm font-medium text-gray-300">Title</label>
                    <input type="text" id="title-input" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                 <div>
                    <label for="author-input" class="block text-sm font-medium text-gray-300">Author</label>
                    <input type="text" id="author-input" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            <div class="mt-6">
                 <button id="save-title-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" class="hidden" accept=".fountain,.txt">

    <script>
        // --- DOM Element References ---
        const fountainInput = document.getElementById('fountain-input');
        const screenplayOutput = document.getElementById('screenplay-output');
        const newBtn = document.getElementById('new-btn');
        const openBtn = document.getElementById('open-btn');
        const fileInput = document.getElementById('file-input');
        const saveMenuBtn = document.getElementById('save-menu-btn');
        const saveMenu = document.getElementById('save-menu');
        const saveFountainBtn = document.getElementById('save-fountain-btn');
        const saveFdxBtn = document.getElementById('save-fdx-btn');
        const savePdfBtn = document.getElementById('save-pdf-btn');
        const shareBtn = document.getElementById('share-btn');
        const undoBtnSide = document.getElementById('undo-btn-side');
        const redoBtnSide = document.getElementById('redo-btn-side');
        const infoBtn = document.getElementById('info-btn');
        const infoModal = document.getElementById('info-modal');
        const closeModalBtn = document.getElementById('close-info-modal-btn');
        const writeView = document.getElementById('write-view');
        const scriptView = document.getElementById('script-view');
        const showScriptBtn = document.getElementById('show-script-btn');
        const showWriteBtn = document.getElementById('show-write-btn');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const menuPanel = document.getElementById('menu-panel');
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const titlePageBtn = document.getElementById('title-page-btn');
        const titlePageModal = document.getElementById('title-page-modal');
        const closeTitleModalBtn = document.getElementById('close-title-modal-btn');
        const saveTitleBtn = document.getElementById('save-title-btn');
        const titleInput = document.getElementById('title-input');
        const authorInput = document.getElementById('author-input');
        const sceneNoBtn = document.getElementById('scene-no-btn');
        const sceneNoIndicator = document.getElementById('scene-no-indicator');
        const sceneNavigatorBtn = document.getElementById('scene-navigator-btn');
        const sceneNavigatorPanel = document.getElementById('scene-navigator-panel');
        const closeNavigatorBtn = document.getElementById('close-navigator-btn');
        const sceneList = document.getElementById('scene-list');
        const autoSaveBtn = document.getElementById('auto-save-btn');
        const autoSaveIndicator = document.getElementById('auto-save-indicator');
        const mobileToolbar = document.getElementById('mobile-bottom-toolbar');
        const fullscreenBtnInlineEditor = document.getElementById('fullscreen-btn-inline-editor');


        // --- Global State ---
        let scriptTitle = "TITLE";
        let scriptAuthor = "written by your name";
        let showSceneNumbers = true;
        let autoSaveIntervalId = null;

        // --- Placeholder Logic ---
        const placeholderText = `Sample Format...
        
INT. ROOM â€“ DAY
Fingers race across a glowing phone screen.
SANTHOSH
(focused)
Keep going, this is worth it.
FADE OUT:

Type screenplay here & click SCRIPT button to format it...`;

        function setPlaceholder() {
            if (fountainInput.value === '') {
                fountainInput.value = placeholderText;
                fountainInput.classList.add('text-gray-500', 'italic');
            }
        }

        function clearPlaceholder() {
            if (fountainInput.value === placeholderText) {
                fountainInput.value = '';
                fountainInput.classList.remove('text-gray-500', 'italic');
            }
        }

        fountainInput.addEventListener('focus', clearPlaceholder);
        fountainInput.addEventListener('blur', setPlaceholder);


        // --- Undo/Redo Manager ---
        const history = {
            stack: [""],
            currentIndex: 0,
            add(value) {
                if (value === placeholderText || value === this.stack[this.currentIndex]) return;
                this.stack = this.stack.slice(0, this.currentIndex + 1);
                this.stack.push(value);
                this.currentIndex++;
                this.updateButtons();
            },
            undo() { if (this.canUndo()) { this.currentIndex--; this.updateInput(); } },
            redo() { if (this.canRedo()) { this.currentIndex++; this.updateInput(); } },
            canUndo: () => history.currentIndex > 0,
            canRedo: () => history.currentIndex < history.stack.length - 1,
            updateInput() {
                fountainInput.value = this.stack[this.currentIndex] || '';
                if(fountainInput.value === ''){
                    setPlaceholder();
                } else {
                    clearPlaceholder();
                }
                this.updateButtons();
            },
            updateButtons() {
                undoBtnSide.disabled = !this.canUndo();
                redoBtnSide.disabled = !this.canRedo();
            }
        };

        // --- PARSING ENGINE (TOKENIZER) ---
        function tokenizeFountain(input) {
            if (input === placeholderText) {
                return [];
            }
            const lines = input.split('\n');
            const tokens = [];
            let inDialogue = false;

            for(let i=0; i < lines.length; i++) {
                const line = lines[i].trim();
                const nextLine = (i + 1 < lines.length) ? lines[i+1].trim() : null;

                if (!line) {
                    tokens.push({ type: 'empty' });
                    inDialogue = false;
                    continue;
                }

                if (line.toUpperCase().startsWith('INT.') || line.toUpperCase().startsWith('EXT.')) {
                    tokens.push({ type: 'sceneHeading', content: line.toUpperCase() });
                    inDialogue = false;
                    continue;
                }

                if (line.toUpperCase().endsWith('TO:') || line.toUpperCase() === 'FADE OUT.' || line.toUpperCase() === 'FADE IN:' || line.toUpperCase() === 'FADE TO BLACK:') {
                    tokens.push({ type: 'transition', content: line.toUpperCase() });
                    inDialogue = false;
                    continue;
                }

                if (line === line.toUpperCase() && !line.startsWith('!') && line.length > 0 && nextLine) {
                    tokens.push({ type: 'character', content: line });
                    inDialogue = true;
                    continue;
                }

                if (inDialogue && line.startsWith('(')) {
                    tokens.push({ type: 'parenthetical', content: line });
                    continue;
                }

                if (inDialogue) {
                    tokens.push({ type: 'dialogue', content: line });
                    continue;
                }

                tokens.push({ type: 'action', content: line });
            }

            return tokens;
        }

        function renderPreview() {
            const rawText = fountainInput.value;
            const tokens = tokenizeFountain(rawText);
            let html = '';
            let sceneNumber = 1;

            if (scriptTitle || scriptAuthor) {
                html += `<div class="title-page">`;
                if (scriptTitle) html += `<h1>${scriptTitle}</h1>`;
                if (scriptAuthor) html += `<h2>${scriptAuthor}</h2>`;
                html += `</div>`;
            }

            tokens.forEach(token => {
                if (token.type === 'sceneHeading') {
                    const sceneText = token.content;
                    const numberedLine = showSceneNumbers ? `<div class="flex justify-between"><span>${sceneText}</span><span>${sceneNumber}</span></div>` : sceneText;
                    html += `<div class="scene-heading">${numberedLine}</div>`;
                    sceneNumber++;
                } else if (token.type === 'empty') {
                    html += '<br>';
                }
                else {
                    html += `<div class="${token.type}">${token.content}</div>`;
                }
            });
            screenplayOutput.innerHTML = html;
        }

        // --- File & Action Handlers ---
        function downloadFile(filename, content, mimeType) {
            const element = document.createElement('a');
            element.setAttribute('href', `data:${mimeType};charset=utf-8,` + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
        
        function createFdxContent(fountainText) {
            const tokens = tokenizeFountain(fountainText);
            let fdxContent = `<?xml version="1.0" encoding="UTF-8" standalone="no"?><FinalDraft DocumentType="Script" Template="No" Version="1"><Content>`;
            tokens.forEach(token => {
                let type = 'Action';
                if (token.type === 'sceneHeading') type = 'Scene Heading';
                if (token.type === 'character') type = 'Character';
                if (token.type === 'dialogue') type = 'Dialogue';
                if (token.type === 'parenthetical') type = 'Parenthetical';
                if (token.type === 'transition') type = 'Transition';
                fdxContent += `<Paragraph Type="${type}"><Text>${token.content}</Text></Paragraph>`;
            });
            fdxContent += `</Content></FinalDraft>`;
            return fdxContent;
        }

        // --- Textarea Manipulation Helpers ---
        let lastTransition = { text: null, start: -1, end: -1 };
        const transitions = ['CUT TO:', 'FADE IN:', 'FADE OUT:', 'FADE TO BLACK:'];
        let lastScene = { text: null, start: -1, end: -1 };
        const scenes = ['INT. ', 'EXT. ', 'INT./EXT. '];
        let lastTime = { text: null, start: -1, end: -1 };
        const times = [' - DAY', ' - NIGHT', ' - DAY / NIGHT'];

        function cycleHelper(textarea, cycleArray, lastState) {
            clearPlaceholder();
            const currentPos = textarea.selectionStart;

            if (lastState.text && currentPos === lastState.end && textarea.value.substring(lastState.start, lastState.end) === lastState.text) {
                const currentIndex = cycleArray.indexOf(lastState.text);
                const nextIndex = (currentIndex + 1) % cycleArray.length;
                const newText = cycleArray[nextIndex];

                textarea.value = textarea.value.substring(0, lastState.start) + newText + textarea.value.substring(lastState.end);
                textarea.selectionStart = textarea.selectionEnd = lastState.start + newText.length;

                lastState.text = newText;
                lastState.end = lastState.start + newText.length;
            } else {
                const newText = cycleArray[0];
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + newText.length;
                
                lastState.start = start;
                lastState.end = start + newText.length;
                lastState.text = newText;
            }
            textarea.focus();
            history.add(textarea.value);
        }


        function insertAtCursor(textarea, text) {
            clearPlaceholder();
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            textarea.focus();
            history.add(textarea.value);
        }

        function wrapWithParens(textarea) {
            clearPlaceholder();
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const newText = `(${selectedText})`;
            textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
            textarea.selectionStart = start + 1;
            textarea.selectionEnd = end + 1;
            textarea.focus();
            history.add(textarea.value);
        }

        function toggleCase(textarea) {
            clearPlaceholder();
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            let newText = '';
            let targetText = '';

            if (start === end) {
                let lineStart = textarea.value.lastIndexOf('\n', start - 1) + 1;
                let lineEnd = textarea.value.indexOf('\n', start);
                if (lineEnd === -1) lineEnd = textarea.value.length;
                
                targetText = textarea.value.substring(lineStart, lineEnd);
                newText = (targetText === targetText.toUpperCase()) ? targetText.toLowerCase() : targetText.toUpperCase();
                textarea.value = textarea.value.substring(0, lineStart) + newText + textarea.value.substring(lineEnd);
                textarea.selectionStart = start;
                textarea.selectionEnd = end;

            } else {
                targetText = textarea.value.substring(start, end);
                newText = (targetText === targetText.toUpperCase()) ? targetText.toLowerCase() : targetText.toUpperCase();
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                textarea.selectionStart = start;
                textarea.selectionEnd = start + newText.length;
            }
            textarea.focus();
            history.add(textarea.value);
        }

        // --- Event Listeners ---
        newBtn.addEventListener('click', () => {
            if (confirm('Start a new project? Unsaved changes will be lost.')) {
                scriptTitle = '';
                scriptAuthor = '';
                fountainInput.value = '';
                screenplayOutput.innerHTML = '';
                setPlaceholder();
                history.stack = [''];
                history.currentIndex = 0;
                history.updateButtons();
                menuPanel.classList.add('-translate-x-full');
            }
        });

        openBtn.addEventListener('click', () => {
            fileInput.click();
            menuPanel.classList.add('-translate-x-full');
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                fountainInput.value = content;
                clearPlaceholder();
                history.stack = ['', content];
                history.currentIndex = 1;
                history.updateButtons();
            };
            reader.readAsText(file);
            fileInput.value = '';
        });

        saveMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            saveMenu.classList.toggle('hidden');
        });
        saveFountainBtn.addEventListener('click', (e) => { 
            e.preventDefault();
            const filename = (scriptTitle || 'script').replace(/\s+/g, '_').replace(/[^\w-]/g, '');
            downloadFile(`${filename}.fountain`, fountainInput.value, 'text/plain'); 
        });
        saveFdxBtn.addEventListener('click', (e) => { 
            e.preventDefault();
            const filename = (scriptTitle || 'script').replace(/\s+/g, '_').replace(/[^\w-]/g, '');
            downloadFile(`${filename}.fdx`, createFdxContent(fountainInput.value), 'application/xml'); 
        });
        shareBtn.addEventListener('click', () => {
             if (navigator.share) {
                 navigator.share({
                     title: scriptTitle || 'My Screenplay',
                     text: fountainInput.value,
                 }).catch((error) => {
                     console.error('Share failed:', error);
                     copyToClipboardFallback();
                 });
             } else {
                 copyToClipboardFallback();
             }
        });

        function copyToClipboardFallback() {
            navigator.clipboard.writeText(fountainInput.value).then(() => {
                shareBtn.textContent = 'Copied!';
                setTimeout(() => {
                    shareBtn.textContent = 'Share';
                }, 2000);
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        }

        infoBtn.addEventListener('click', () => {
            infoModal.classList.remove('hidden');
            menuPanel.classList.add('-translate-x-full');
        });

        document.querySelectorAll('.action-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const action = e.currentTarget.dataset.action;
                switch(action) {
                    case 'caps': toggleCase(fountainInput); break;
                    case 'parens': wrapWithParens(fountainInput); break;
                    case 'transition': cycleHelper(fountainInput, transitions, lastTransition); break;
                    case 'scene': cycleHelper(fountainInput, scenes, lastScene); break;
                    case 'time': cycleHelper(fountainInput, times, lastTime); break;
                }
            });
        });

        savePdfBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'letter' });

            const SCREENPLAY_SETTINGS = {
                font: 'Courier',
                fontSizePt: 12,
                lineHeightPt: 12,
            };

            const FORMATTING = {
                sceneHeading: { leftMarginIn: 1.5, rightMarginIn: 1.0, lineSpacingBefore: 1, lineSpacingAfter: 1 },
                action: { leftMarginIn: 1.5, rightMarginIn: 1.0, lineSpacingBefore: 0, lineSpacingAfter: 0 },
                character: { leftMarginIn: 3.7, lineSpacingBefore: 1, lineSpacingAfter: 0 },
                parenthetical: { leftMarginIn: 3.1, lineSpacingBefore: 0, lineSpacingAfter: 0 },
                dialogue: { leftMarginIn: 2.5, rightMarginIn: 2.5, lineSpacingBefore: 0, lineSpacingAfter: 0 },
                transition: { leftMarginIn: 1.5, rightMarginIn: 1.0, align: 'right', lineSpacingBefore: 1, lineSpacingAfter: 1 },
                empty: { lineSpacingBefore: 1, lineSpacingAfter: 0}
            };

            const margins = { top: 72, bottom: 72, left: 108, right: 72 };
            const pageHeight = doc.internal.pageSize.getHeight();
            let cursorY = margins.top;

            doc.setFont(SCREENPLAY_SETTINGS.font, 'normal');
            doc.setFontSize(SCREENPLAY_SETTINGS.fontSizePt);

            const checkPageBreak = (neededHeight) => {
                if (cursorY + neededHeight > pageHeight - margins.bottom) {
                    doc.addPage();
                    cursorY = margins.top;
                }
            };

            if (scriptTitle || scriptAuthor) {
                const titleY = pageHeight / 3;
                if (scriptTitle) {
                    doc.text(scriptTitle.toUpperCase(), doc.internal.pageSize.getWidth() / 2, titleY, { align: 'center' });
                }
                if (scriptAuthor) {
                    doc.text("Written by", doc.internal.pageSize.getWidth() / 2, titleY + 40, { align: 'center' });
                    doc.text(scriptAuthor, doc.internal.pageSize.getWidth() / 2, titleY + 60, { align: 'center' });
                }
                doc.addPage();
            }

            const tokens = tokenizeFountain(fountainInput.value);
            let sceneNumber = 1;

            tokens.forEach(token => {
                const config = FORMATTING[token.type];
                if (!config) return;

                cursorY += config.lineSpacingBefore * SCREENPLAY_SETTINGS.lineHeightPt;
                checkPageBreak(SCREENPLAY_SETTINGS.lineHeightPt);

                const leftMargin = config.leftMarginIn * 72;
                const rightMargin = (config.rightMarginIn || 1.0) * 72;
                const availableWidth = doc.internal.pageSize.getWidth() - leftMargin - rightMargin;
                
                let textLines = doc.splitTextToSize(token.content || '', availableWidth);
                
                if (token.type === 'sceneHeading' && showSceneNumbers) {
                    const sceneNumStr = `${sceneNumber}`;
                    const sceneText = token.content;
                    checkPageBreak(SCREENPLAY_SETTINGS.lineHeightPt);
                    doc.text(sceneText, margins.left, cursorY);
                    doc.text(sceneNumStr, doc.internal.pageSize.getWidth() - margins.right, cursorY, { align: 'right' });
                    cursorY += SCREENPLAY_SETTINGS.lineHeightPt;
                    sceneNumber++;
                } else {
                     textLines.forEach(line => {
                         checkPageBreak(SCREENPLAY_SETTINGS.lineHeightPt);
                         let xPos = leftMargin;
                         if(config.align === 'right') {
                            xPos = doc.internal.pageSize.getWidth() - rightMargin;
                         }
                         doc.text(line, xPos, cursorY, { align: config.align || 'left' });
                         cursorY += SCREENPLAY_SETTINGS.lineHeightPt;
                     });
                }
                cursorY += config.lineSpacingAfter * SCREENPLAY_SETTINGS.lineHeightPt;
            });

            const filename = (scriptTitle || 'script').replace(/\s+/g, '_').replace(/[^\w-]/g, '');
            doc.save(`${filename}.pdf`);
        });

        let inputTimeout;
        fountainInput.addEventListener('input', () => {
            clearTimeout(inputTimeout);
            inputTimeout = setTimeout(() => history.add(fountainInput.value), 300);
        });

        undoBtnSide.addEventListener('click', () => history.undo());
        redoBtnSide.addEventListener('click', () => history.redo());
        
        closeModalBtn.addEventListener('click', () => infoModal.classList.add('hidden'));
        
        // View Switching Logic
        showScriptBtn.addEventListener('click', () => {
            renderPreview();
            writeView.classList.add('hidden');
            scriptView.classList.remove('hidden');
            scriptView.classList.add('flex');
        });

        showWriteBtn.addEventListener('click', () => {
            scriptView.classList.add('hidden');
            scriptView.classList.remove('flex');
            writeView.classList.remove('hidden');
        });

        // Hamburger Menu Logic
        hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            menuPanel.classList.toggle('-translate-x-full');
        });
        document.addEventListener('click', (e) => {
            if (!menuPanel.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                 menuPanel.classList.add('-translate-x-full');
            }
        });

        // Fullscreen Logic
        const toggleFullscreen = () => {
             if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
             } else {
                 document.exitFullscreen();
             }
        };
        fullscreenBtnInlineEditor.addEventListener('click', toggleFullscreen);
        
        // Zoom Logic
        let currentFontSize = 16;
        const updateFontSize = () => {
            fountainInput.style.fontSize = `${currentFontSize}px`;
        };
        zoomInBtn.addEventListener('click', () => {
            currentFontSize += 2;
            updateFontSize();
        });
        zoomOutBtn.addEventListener('click', () => {
            currentFontSize = Math.max(8, currentFontSize - 2);
            updateFontSize();
        });
        
        // Title Page Modal Logic
        titlePageBtn.addEventListener('click', () => {
            titleInput.value = scriptTitle;
            authorInput.value = scriptAuthor;
            titlePageModal.classList.remove('hidden');
            menuPanel.classList.add('-translate-x-full');
        });
        closeTitleModalBtn.addEventListener('click', () => titlePageModal.classList.add('hidden'));
        saveTitleBtn.addEventListener('click', () => {
            scriptTitle = titleInput.value;
            scriptAuthor = authorInput.value;
            titlePageModal.classList.add('hidden');
        });
        
        // Scene Number Toggle Logic
        sceneNoBtn.addEventListener('click', () => {
            showSceneNumbers = !showSceneNumbers;
            sceneNoIndicator.classList.toggle('bg-green-500', showSceneNumbers);
            sceneNoIndicator.classList.toggle('bg-gray-500', !showSceneNumbers);
        });
        
        // Auto-Save Logic
        autoSaveBtn.addEventListener('click', () => {
            if (autoSaveIntervalId) {
                clearInterval(autoSaveIntervalId);
                autoSaveIntervalId = null;
                autoSaveIndicator.classList.remove('bg-green-500');
                autoSaveIndicator.classList.add('bg-gray-500');
            } else {
                autoSaveIntervalId = setInterval(() => {
                    const filename = (scriptTitle || 'autosave_script').replace(/\s+/g, '_').replace(/[^\w-]/g, '');
                    downloadFile(`${filename}.fountain`, fountainInput.value, 'text/plain');
                }, 120000);
                autoSaveIndicator.classList.add('bg-green-500');
                autoSaveIndicator.classList.remove('bg-gray-500');
            }
        });

        // Scene Navigator Logic
        sceneNavigatorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            populateSceneNavigator();
            sceneNavigatorPanel.classList.toggle('translate-x-full');
        });
        
        closeNavigatorBtn.addEventListener('click', () => {
            sceneNavigatorPanel.classList.add('translate-x-full');
        });
        
        document.addEventListener('click', (e) => {
            if (!sceneNavigatorPanel.contains(e.target) && !sceneNavigatorBtn.contains(e.target)) {
                 sceneNavigatorPanel.classList.add('translate-x-full');
            }
        });

        function populateSceneNavigator() {
            sceneList.innerHTML = '';
            const lines = fountainInput.value.split('\n');
            let sceneIndex = 0;
            lines.forEach((line) => {
                const trimmedLine = line.trim().toUpperCase();
                if (trimmedLine.startsWith('INT.') || trimmedLine.startsWith('EXT.')) {
                    const li = document.createElement('li');
                    li.textContent = line;
                    li.className = 'p-2 text-gray-300 bg-gray-700 rounded-md mb-2 cursor-grab';
                    li.draggable = true;
                    li.dataset.sceneIndex = sceneIndex++;
                    sceneList.appendChild(li);
                }
            });
        }
        
        let draggedItem = null;

        sceneList.addEventListener('dragstart', e => {
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        });

        sceneList.addEventListener('dragend', e => {
            e.target.classList.remove('dragging');
        });

        sceneList.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(sceneList, e.clientY);
            if (afterElement == null) {
                sceneList.appendChild(draggedItem);
            } else {
                sceneList.insertBefore(draggedItem, afterElement);
            }
        });

        sceneList.addEventListener('drop', () => {
            reorderScript();
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('li:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function reorderScript() {
            const fullText = fountainInput.value;
            const lines = fullText.split('\n');

            const sceneBlocks = [];
            let nonSceneHeader = [];
            let currentSceneBlock = [];
            let isFirstSceneFound = false;

            lines.forEach(line => {
                const isSceneHeading = line.trim().toUpperCase().startsWith('INT.') || line.trim().toUpperCase().startsWith('EXT.');
                
                if (isSceneHeading) {
                    if (!isFirstSceneFound) {
                        isFirstSceneFound = true;
                    }
                    if (currentSceneBlock.length > 0) {
                        sceneBlocks.push(currentSceneBlock.join('\n'));
                    }
                    currentSceneBlock = [line];
                } else {
                    if (isFirstSceneFound) {
                        currentSceneBlock.push(line);
                    } else {
                        nonSceneHeader.push(line);
                    }
                }
            });
            if (currentSceneBlock.length > 0) {
                sceneBlocks.push(currentSceneBlock.join('\n'));
            }

            const newOrderIndices = [...sceneList.querySelectorAll('li')].map(li => parseInt(li.dataset.sceneIndex));
            const reorderedSceneBlocks = newOrderIndices.map(index => sceneBlocks[index]);

            const headerText = nonSceneHeader.join('\n');
            const newScriptArray = [];

            if (headerText.trim() !== '') {
                newScriptArray.push(headerText);
            }
            newScriptArray.push(...reorderedSceneBlocks);

            fountainInput.value = newScriptArray.join('\n\n');
            history.add(fountainInput.value);
            renderPreview();
        }
        
        if ('visualViewport' in window) {
            const handleViewportChange = () => {
                const keyboardHeight = window.innerHeight - window.visualViewport.height;
                if (keyboardHeight > 100) {
                    mobileToolbar.style.bottom = `${keyboardHeight}px`;
                } else {
                    mobileToolbar.style.bottom = '-100px';
                }
            };
            
            fountainInput.addEventListener('focus', () => {
                setTimeout(() => window.visualViewport.addEventListener('resize', handleViewportChange), 100);
            });
            
            fountainInput.addEventListener('blur', () => {
                window.visualViewport.removeEventListener('resize', handleViewportChange);
                mobileToolbar.style.bottom = '-100px';
            });
        }

        // --- Initialization ---
        setPlaceholder();
        history.stack = [''];
        history.currentIndex = 0;
        history.updateButtons();
        updateFontSize();
    </script>
</body>
</html>
